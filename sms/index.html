<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>获取手机验证码</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    .container { max-width: 600px; margin: 0 auto; }
    .box { margin: 10px 0; }
    input { padding: 5px; width: 200px; }
    button { padding: 5px 10px; margin: 5px; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #msg { color: red; }
    @media (max-width: 600px) { input { width: 100%; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="box">
      <input id="phone" readonly placeholder="点击取号获取号码">
      <button id="getPhone">取号</button>
      <button id="changePhone" disabled>换号</button>
      <button id="copyPhone" style="display:none">复制1</button>
    </div>
    <div class="box">
      <input id="sms" readonly placeholder="短信内容">
      <button id="copySms" style="display:none">复制2</button>
    </div>
    <div id="msg"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");
    const apiBase = `${window.location.origin}`;

    let phone = null;
    let smsTimer = null;

    document.getElementById("getPhone").onclick = async () => {
      disableButtons();
      await sleep(1000);
      const res = await fetch(`${apiBase}/getPhone?token=${token}`);
      const data = await res.json();
      const msg = document.getElementById("msg");

      if (data.code === 0) {
        phone = data.phone;
        document.getElementById("phone").value = phone;
        document.getElementById("getPhone").style.display = "none";
        document.getElementById("copyPhone").style.display = "inline";
        document.getElementById("changePhone").disabled = false;
        msg.textContent = "取号成功";
        startSmsPolling();
      } else {
        msg.textContent = "未获取到手机号码，请重试";
        await sleep(500);
        msg.textContent = "";
        enableGetPhoneButton();
      }
    };

    document.getElementById("changePhone").onclick = async () => {
      disableButtons();
      await fetch(`${apiBase}/cancelAllRecv?token=${token}`);
      clearInterval(smsTimer);
      document.getElementById("phone").value = "";
      document.getElementById("sms").value = "";
      document.getElementById("msg").textContent = "";
      document.getElementById("copyPhone").style.display = "none";
      document.getElementById("copySms").style.display = "none";
      document.getElementById("getPhone").style.display = "inline";
      enableGetPhoneButton();
    };

    document.getElementById("copyPhone").onclick = () => navigator.clipboard.writeText(phone);
    document.getElementById("copySms").onclick = () => navigator.clipboard.writeText(document.getElementById("sms").value);

    function startSmsPolling() {
      let timeElapsed = 0;
      smsTimer = setInterval(async () => {
        timeElapsed += 2;
        const res = await fetch(`${apiBase}/getMessage?token=${token}`);
        const data = await res.json();

        if (data.code === 0) {
          document.getElementById("sms").value = data.sms;
          document.getElementById("copySms").style.display = "inline";
          document.getElementById("changePhone").style.display = "none";
          clearInterval(smsTimer);
        } else if (timeElapsed >= 60) {
          document.getElementById("msg").textContent = "60秒未收到验证码，请点击换号";
          clearInterval(smsTimer);
          document.getElementById("changePhone").disabled = false;
        }
      }, 2000);
    }

    function disableButtons() {
      document.getElementById("getPhone").disabled = true;
      document.getElementById("changePhone").disabled = true;
    }

    function enableGetPhoneButton() {
      setTimeout(() => {
        document.getElementById("getPhone").disabled = false;
      }, 5000); // 5秒取号间隔
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 检查缓存中的号码和短信
    (async () => {
      const res = await fetch(`${apiBase}/getMessage?token=${token}`);
      const data = await res.json();
      if (data.phone) {
        phone = data.phone;
        document.getElementById("phone").value = phone;
        document.getElementById("getPhone").style.display = "none";
        document.getElementById("copyPhone").style.display = "inline";
        document.getElementById("changePhone").style.display = "none";
        if (data.sms) {
          document.getElementById("sms").value = data.sms;
          document.getElementById("copySms").style.display = "inline";
        }
      }
    })();
  </script>
</body>
</html>
